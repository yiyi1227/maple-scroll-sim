<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>楓之谷卷軸模擬器（手機支援）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  *{box-sizing:border-box}
  body{font-family:Arial, sans-serif;background:#f0f6ff;margin:0;padding:0;user-select:none}
  h2{text-align:center;margin:15px 0 10px}
  .controls{text-align:center;margin-bottom:10px;font-size:14px}
  .layout{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding:0 10px}
  .scroll{width:130px;padding:10px;border:2px solid #ccc;border-radius:8px;background:#fff;text-align:center;position:sticky;top:0;z-index:999}
  .scroll img{width:80px;cursor:pointer;margin:8px 0;border:2px solid transparent;border-radius:6px}
  .scroll img.selected{border-color:#00aaff;box-shadow:0 0 5px #00aaff}
  .equip-area{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;flex:1;min-width:200px}
  .equip{padding:10px;border:2px dashed #888;border-radius:8px;background:#fff;transition:background-color .3s; min-height: 150px;}
  .equip.failed{background:#d7dbe0}
  .equip.dian{background:#ffb94f;border-style:solid;}
  .equip img{width:80px}
  .equip-title{font-weight:bold;font-size:13px;margin-bottom:4px;min-height:24px;text-align:center}
  .equip-log{font-size:11px;line-height:1.3;height:60px;overflow-y:auto;background:#eef3ff;border-radius:4px;padding:4px 6px;white-space:nowrap}
  #summary{
    margin:10px auto;
    padding:8px 12px;
    border:2px solid #4a7;
    border-radius:8px;
    background:#eaffea;
    font-size:14px;
    width:max-content;
    min-height:230px;
    max-height:230px;
    overflow: hidden;
    text-align:left;
    transition: height 0.2s;
    box-sizing: border-box;
  }
  .equip.add-card {
    border-style: dashed;
    color: #aaa;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 38px;
    cursor: pointer;
    transition: background .2s;
    min-height: 150px;
  }
  .equip.add-card:hover { background: #f4eec0; }
  .equip.add-card img { width: 48px; margin-bottom: 6px; }
  .bar-row {
    display: flex;
    align-items: flex-end;
    margin: 5px 0;
    gap: 3px;
    height: 52px;   /* 條狀圖總高度固定 */
    max-height: 52px;
    overflow: hidden;
  }
  .bar {
    width: 22px;
    background: #88bfff;
    border-radius: 4px 4px 0 0;
    text-align: center;
    color: #333;
    font-size: 13px;
    position: relative;
    border:1px solid #eee;
    transition:height 0.15s;
    display: flex; align-items: flex-end; justify-content:center;
  }
  .bar.full {background:#FFD447;}
  .bar-num {
    text-align:center; font-size:12px; color:#666; margin-top:2px; width:22px;
  }
  .bar:hover:after {
    content: attr(data-tip);
    position: absolute; top: -22px; left: 50%; transform: translateX(-50%);
    background: #fff9b1; color: #222; border-radius: 4px; padding:2px 8px; font-size:12px; box-shadow:0 0 4px #aaa;
    white-space:nowrap; z-index:2;
  }
  @media (max-width:600px) {
  .scroll {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    max-width: 100vw;
    z-index: 1200;
    background: #fff7cd !important; /* 你想要的底色，這裡用溫柔黃色 */
    box-shadow: 0 3px 10px -4px #9994;
    border-radius: 0 0 12px 12px;
    margin: 0;
    border-top-left-radius:0;
    border-top-right-radius:0;
  }
  #summary {
    position: sticky;
    top: 74px; /* scroll 卷軸高度＋間隔，讓 summary 在卷軸下方 */
    z-index: 1100;
    box-shadow: 0 3px 8px -3px #8884;
  }
  .layout {
    padding-top: 86px; /* 預留卷軸吸頂空間，視覺不卡住 */
  }
}

</style>
</head>
<body>

<h2>🍁 楓之谷衝捲模擬器</h2>

<div class="controls">
  裝備類型：<select id="equipType">
    <option value="glove">🧤 手套 (5捲)</option>
    <option value="weapon">⚔️ 武器 (7捲)</option>
  </select>
  ｜裝備數量：<input id="equipCount" type="number" min="1" value="1" style="width:50px">
  <button onclick="generateEquips()">生成裝備</button>
  <button onclick="resetAll()">🔄 重製全部</button>
</div>

<div id="summary"></div>

<div class="layout">
  <div class="scroll">
    <p>📜 卷軸</p>
    <img src="scroll60.png" data-rate="60" title="60% 卷軸" draggable="true">
    <img src="scroll10.png" data-rate="10" title="10% 卷軸" draggable="true">
  </div>
  <div id="equipArea" class="equip-area"></div>
</div>

<script>
const equipMax = { glove: 5, weapon: 7 };
const equipImg = { glove: 'glove.png', weapon: 'weapon.png' };

let total60 = 0, total10 = 0, totalSucc = 0, totalUsed = 0;
let selectedScroll = null;
let equipIndex = 1;
window.equips = [];

document.querySelectorAll('.scroll img').forEach(img => {
  img.addEventListener('dragstart', e => e.dataTransfer.setData('rate', img.dataset.rate));
  img.addEventListener('click', () => {
    selectedScroll = parseInt(img.dataset.rate);
    document.querySelectorAll('.scroll img').forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
  });
});

function renderEquipArea() {
  const area = document.getElementById('equipArea');
  area.innerHTML = '';
  window.equips.forEach(e => area.appendChild(e));
  const addDiv = document.createElement('div');
  addDiv.className = 'equip add-card';
  addDiv.innerHTML = '<div style="font-size:54px;line-height:1;">+</div><div style="font-size:12px;margin-top:5px;">新增裝備</div>';
  addDiv.onclick = function(){ addSingleEquip(); };
  area.appendChild(addDiv);
}

function addEquip(type, isDian) {
  const idx = equipIndex++;
  const div = document.createElement('div');
  div.className = 'equip' + (isDian ? ' dian' : '');
  div.dataset.max = isDian ? 999 : equipMax[type];
  div.dataset.used = 0;
  div.dataset.succ = 0;
  div.dataset.idx = idx;
  div.dataset.type = type;
  div.dataset.dian = isDian ? "1" : "";
  div.innerHTML = `
    <div class="equip-title" id="title-${idx}">
      ${isDian ? '🟧 墊卷裝備' : (type === 'glove' ? '🧤 手套' : '⚔️ 武器')} #${idx}（0/${isDian ? 'N' : equipMax[type]}）
    </div>
    <div style="text-align:center"><img src="${equipImg[type]}"></div>
    <div class="equip-log" id="log-${idx}">尚未使用卷軸</div>
  `;
  div.ondragover = e => e.preventDefault();
  div.ondrop = e => {
    e.preventDefault();
    const rate = parseInt(e.dataTransfer.getData('rate'));
    applyScroll(div, rate);
  };
  div.addEventListener('pointerup', () => {
    if (selectedScroll !== null) applyScroll(div, selectedScroll);
  });
  window.equips.push(div);
  renderEquipArea();
}

function generateEquips() {
  window.equips = [];
  total60 = total10 = totalSucc = totalUsed = 0;
  selectedScroll = null;
  equipIndex = 1;
  document.querySelectorAll('.scroll img').forEach(i => i.classList.remove('selected'));
  updateSummary();
  addEquip('glove', true);
  const type = document.getElementById('equipType').value;
  const cnt = parseInt(document.getElementById('equipCount').value);
  for (let i = 1; i <= cnt; i++) addEquip(type, false);
}

function addSingleEquip() {
  addEquip(document.getElementById('equipType').value, false);
  updateSummary();
}

function applyScroll(equip, rate) {
  if (isNaN(rate) || equip.dataset.lock) return;
  equip.dataset.lock = '1';
  requestAnimationFrame(() => delete equip.dataset.lock);
  let used = +equip.dataset.used, succ = +equip.dataset.succ;
  const max = +equip.dataset.max, idx = equip.dataset.idx, isDian = equip.dataset.dian === "1";
  if (!isDian && used >= max) { alert('❌ 此裝備已無法再使用卷軸！'); return; }
  const ok = Math.random() <= rate / 100;
  if (ok) succ++;
  used++;
  equip.dataset.used = used; equip.dataset.succ = succ;
  if (rate === 60) total60++; else total10++;
  if (ok) totalSucc++;
  totalUsed++;
  updateSummary();
  if (!isDian && used > succ) equip.classList.add('failed');
  document.getElementById('title-' + idx).innerText =
    (isDian ? '🟧 墊卷裝備' : (equip.dataset.type === 'glove' ? '🧤 手套' : '⚔️ 武器')) + ` #${idx}（${isDian ? (succ ? succ : 'N') + '/N' : succ + '/' + max}）`;
  const log = document.getElementById('log-' + idx);
  if (used === 1) log.innerHTML = '';
  log.innerHTML += `第 ${used}/${isDian ? 'N' : max} 次 (${rate}%): ${ok ? '✅ 成功' : '❌ 失敗'}<br>`;
  log.scrollTop = log.scrollHeight;
}

//「至少有一件全過」機率（不含墊卷裝備）
function atLeastOnePerfect(prob) {
  let q = 1;
  for (let p of prob) q *= (1 - p);
  return 1 - q;
}
function getEachPerfectProb(rate) {
  let equips = window.equips.filter(e =>
    e.dataset.dian !== "1" && !e.classList.contains('failed') && +e.dataset.used < +e.dataset.max
  );
  let arr = [];
  for (let e of equips) {
    let left = +e.dataset.max - +e.dataset.used;
    if (left > 0) arr.push(Math.pow(rate / 100, left));
  }
  return arr;
}
// 計算已經全過的件數
function countFullPass() {
  let cnt = 0, max = 0;
  window.equips.forEach(e => {
    if (e.dataset.dian === "1") return;
    const s = +e.dataset.succ, m = +e.dataset.max;
    if (s === m && m > 0) cnt++;
    if (m > max) max = m;
  });
  return {cnt, max};
}
// 捲成功統計條狀圖（固定最大高度、超出自動壓縮）
function buildStatBar() {
  let stat = {}, max = 0, maxValue = 0;
  window.equips.forEach(e => {
    if (e.dataset.dian === "1") return;
    const s = parseInt(e.dataset.succ), m = +e.dataset.max;
    if (m > max) max = m;
    stat[s] = (stat[s] || 0) + 1;
    if (stat[s] > maxValue) maxValue = stat[s];
  });
  if (max === 0) return "（尚無資料）";
  const BAR_MAX_HEIGHT = 42;  // px
  let html = '<div class="bar-row">';
  for (let i = 0; i <= max; i++) {
    let v = stat[i] || 0;
    let h = maxValue > 0 ? Math.round((v / maxValue) * BAR_MAX_HEIGHT) : 8;
    if (v > 0 && h < 16) h = 16; // 最小高度
    html += `<div class="bar${i===max?' full':''}" style="height:${h}px" data-tip="${i}捲成功：${v}件">${v > 0 ? v : ''}</div>`;
  }
  html += '</div><div class="bar-row" style="height:auto">';
  for (let i = 0; i <= max; i++) html += `<div class="bar-num">${i}</div>`;
  html += '</div>';
  return html;
}
function updateSummary() {
  const rate = totalUsed ? (totalSucc / totalUsed * 100).toFixed(1) : '0.0';
  const prob60Arr = getEachPerfectProb(60);
  const prob10Arr = getEachPerfectProb(10);
  // 有全過的直接顯示
  const {cnt: fullCnt, max: maxRoll} = countFullPass();
  let passStr = '';
  if (fullCnt > 0) {
    passStr = `<span style="color:#D4A000;"><b>已達成全過裝備數量：${fullCnt} 件</b></span>`;
  } else {
    const atLeastOne60 = (atLeastOnePerfect(prob60Arr) * 100).toFixed(4);
    const atLeastOne10 = (atLeastOnePerfect(prob10Arr) * 100).toFixed(8);
    passStr = `<b>剩餘裝備「至少有一件全過」機率：</b><br>
     ▶️ 60%卷軸全過：${atLeastOne60}%<br>
     ▶️ 10%卷軸全過：${atLeastOne10}%`;
  }
  document.getElementById('summary').innerHTML =
    `60% 卷軸：${total60} 張｜10% 卷軸：${total10} 張｜成功：${totalSucc} / ${totalUsed}（${rate} %）<br>
     🎯 <b>成功捲數分布：</b> ${buildStatBar()}
     <hr style="border:0;border-top:1px dashed #aaa">
     ${passStr}`;
}
function resetAll() {
  window.equips.forEach(e => {
    const max = +e.dataset.max, idx = e.dataset.idx, isDian = e.dataset.dian === "1";
    e.dataset.used = 0; e.dataset.succ = 0; e.classList.remove('failed');
    document.getElementById('title-' + idx).innerText =
      (isDian ? '🟧 墊卷裝備' : (e.dataset.type === 'glove' ? '🧤 手套' : '⚔️ 武器')) + ` #${idx}（${isDian ? 'N/N' : '0/' + max}）`;
    document.getElementById('log-' + idx).innerText = '尚未使用卷軸';
  });
  total60 = total10 = totalSucc = totalUsed = 0;
  selectedScroll = null;
  document.querySelectorAll('.scroll img').forEach(i => i.classList.remove('selected'));
  updateSummary();
}
generateEquips();
</script>
</body>
</html>
