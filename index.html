<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ¥“ä¹‹è°·è¡æ²æ¨¡æ“¬å™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  *{box-sizing:border-box}
  body{font-family:Arial, sans-serif;background:#f0f6ff;margin:0;padding:0;user-select:none}
  h2{text-align:center;margin:15px 0 10px}
  .controls{text-align:center;margin-bottom:10px;font-size:14px}
  .layout{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;padding:0 10px}
  .scroll{width:130px;padding:10px;border:2px solid #ccc;border-radius:8px;background:#fff;text-align:center;position:sticky;top:0;z-index:999}
  .scroll img{width:80px;cursor:pointer;margin:8px 0;border:2px solid transparent;border-radius:6px}
  .scroll img.selected{border-color:#00aaff;box-shadow:0 0 5px #00aaff}
  .equip-area{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;flex:1;min-width:200px}
  .equip{padding:10px;border:2px dashed #888;border-radius:8px;background:#fff;transition:background-color .3s; min-height: 150px;}
  .equip.failed{background:#d7dbe0}
  .equip.dian{background:#ffb94f;border-style:solid;}
  .equip img{width:80px}
  .equip-title{font-weight:bold;font-size:13px;margin-bottom:4px;min-height:24px;text-align:center}
  .equip-log{font-size:11px;line-height:1.3;height:60px;overflow-y:auto;background:#eef3ff;border-radius:4px;padding:4px 6px;white-space:nowrap}
  #summary{margin:10px auto;padding:8px 12px;border:2px solid #4a7;border-radius:8px;background:#eaffea;font-size:14px;width:max-content;text-align:left}
  /* åŠ è™Ÿè£å‚™å¡ç‰‡ */
  .equip.add-card {
    border-style: dashed;
    color: #aaa;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 38px;
    cursor: pointer;
    transition: background .2s;
    min-height: 150px;
  }
  .equip.add-card:hover { background: #f4eec0; }
  .equip.add-card img { width: 48px; margin-bottom: 6px; }
  @media(max-width:600px){
    .layout{flex-direction:column;align-items:center}
    .scroll{width:100%;max-width:300px;order:-1}
    .equip-area{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));width:100%}
    h2{font-size:18px}.controls{font-size:12px}
  }
</style>
</head>
<body>

<h2>ğŸ æ¥“ä¹‹è°·è¡æ²æ¨¡æ“¬å™¨</h2>

<div class="controls">
  è£å‚™é¡å‹ï¼š<select id="equipType">
    <option value="glove">ğŸ§¤ æ‰‹å¥— (5æ²)</option>
    <option value="weapon">âš”ï¸ æ­¦å™¨ (7æ²)</option>
  </select>
  ï½œè£å‚™æ•¸é‡ï¼š<input id="equipCount" type="number" min="1" value="1" style="width:50px">
  <button onclick="generateEquips()">ç”Ÿæˆè£å‚™</button>
  <button onclick="resetAll()">ğŸ”„ é‡è£½å…¨éƒ¨</button>
</div>

<div id="summary">60% å·è»¸ï¼š0 å¼µï½œ10% å·è»¸ï¼š0 å¼µï½œæˆåŠŸï¼š0 / 0ï¼ˆ0.0 %ï¼‰<br>ğŸ¯ æˆåŠŸæ²æ•¸çµ±è¨ˆï¼š<br></div>

<div class="layout">
  <div class="scroll">
    <p>ğŸ“œ å·è»¸</p>
    <img src="scroll60.png" data-rate="60" title="60% å·è»¸" draggable="true">
    <img src="scroll10.png" data-rate="10" title="10% å·è»¸" draggable="true">
  </div>
  <div id="equipArea" class="equip-area"></div>
</div>

<script>
const equipMax = { glove: 5, weapon: 7 };
const equipImg = { glove: 'glove.png', weapon: 'weapon.png' };

let total60 = 0, total10 = 0, totalSucc = 0, totalUsed = 0;
let selectedScroll = null;
let equipIndex = 1; // forè£å‚™index

window.equips = []; // å…¨éƒ¨è£å‚™ï¼ˆä¸å«åŠ è™Ÿå¡ï¼‰

// å·è»¸é»é¸
document.querySelectorAll('.scroll img').forEach(img => {
  img.addEventListener('dragstart', e => e.dataTransfer.setData('rate', img.dataset.rate));
  img.addEventListener('click', () => {
    selectedScroll = parseInt(img.dataset.rate);
    document.querySelectorAll('.scroll img').forEach(i => i.classList.remove('selected'));
    img.classList.add('selected');
  });
});

function renderEquipArea() {
  const area = document.getElementById('equipArea');
  area.innerHTML = '';
  // è£å‚™å¡
  window.equips.forEach(e => area.appendChild(e));
  // æœ€å¾ŒåŠ ã€Œ+ã€å¡ç‰‡ï¼ˆå¦‚è¦ç”¨ä½ ä¸Šå‚³çš„åœ–ï¼Œæ”¹ä¸‹é¢innerHTMLï¼‰
  const addDiv = document.createElement('div');
  addDiv.className = 'equip add-card';
  // ç”¨ã€Œ+ã€
  addDiv.innerHTML = '<div style="font-size:54px;line-height:1;">+</div><div style="font-size:12px;margin-top:5px;">æ–°å¢è£å‚™</div>';
  // æˆ–ç”¨åœ–ç‰‡ï¼ˆå–æ¶ˆä¸Šé¢å…©è¡Œè¨»è§£é€™è¡Œå³å¯ï¼‰ï¼š
  // addDiv.innerHTML = '<img src="/mnt/data/651a233f-9bd7-4581-99d5-3015f4509f2c.png"><div style="font-size:12px;margin-top:5px;">æ–°å¢è£å‚™</div>';
  addDiv.onclick = function(){ addSingleEquip(); };
  area.appendChild(addDiv);
}

// æ–°å¢è£å‚™(æ‰‹å‹• or æ‰¹æ¬¡)
function addEquip(type, isDian) {
  const idx = equipIndex++;
  const div = document.createElement('div');
  div.className = 'equip' + (isDian ? ' dian' : '');
  div.dataset.max = isDian ? 999 : equipMax[type]; // å¢Šå·ç„¡é™
  div.dataset.used = 0;
  div.dataset.succ = 0;
  div.dataset.idx = idx;
  div.dataset.type = type;
  div.dataset.dian = isDian ? "1" : "";
  div.innerHTML = `
    <div class="equip-title" id="title-${idx}">
      ${isDian ? 'ğŸŸ§ å¢Šå·è£å‚™' : (type === 'glove' ? 'ğŸ§¤ æ‰‹å¥—' : 'âš”ï¸ æ­¦å™¨')} #${idx}ï¼ˆ0/${isDian ? 'N' : equipMax[type]}ï¼‰
    </div>
    <div style="text-align:center"><img src="${equipImg[type]}"></div>
    <div class="equip-log" id="log-${idx}">å°šæœªä½¿ç”¨å·è»¸</div>
  `;
  // æ‹–æ›³
  div.ondragover = e => e.preventDefault();
  div.ondrop = e => {
    e.preventDefault();
    const rate = parseInt(e.dataTransfer.getData('rate'));
    applyScroll(div, rate);
  };
  div.addEventListener('pointerup', () => {
    if (selectedScroll !== null) applyScroll(div, selectedScroll);
  });
  window.equips.push(div);
  renderEquipArea();
}

// æ‰¹æ¬¡ç”Ÿæˆ
function generateEquips() {
  window.equips = [];
  total60 = total10 = totalSucc = totalUsed = 0;
  selectedScroll = null;
  equipIndex = 1;
  document.querySelectorAll('.scroll img').forEach(i => i.classList.remove('selected'));
  updateSummary();

  // å…ˆåŠ ã€Œå¢Šå·è£å‚™ã€
  addEquip('glove', true);
  // å…¶ä»–è£å‚™
  const type = document.getElementById('equipType').value;
  const cnt = parseInt(document.getElementById('equipCount').value);
  for (let i = 1; i <= cnt; i++) addEquip(type, false);
}

// æ‰‹å‹•æ–°å¢è£å‚™
function addSingleEquip() {
  addEquip(document.getElementById('equipType').value, false);
  updateSummary();
}

// è¡æ²
function applyScroll(equip, rate) {
  if (isNaN(rate) || equip.dataset.lock) return;
  equip.dataset.lock = '1';
  requestAnimationFrame(() => delete equip.dataset.lock);

  let used = +equip.dataset.used, succ = +equip.dataset.succ;
  const max = +equip.dataset.max, idx = equip.dataset.idx, isDian = equip.dataset.dian === "1";
  if (!isDian && used >= max) { alert('âŒ æ­¤è£å‚™å·²ç„¡æ³•å†ä½¿ç”¨å·è»¸ï¼'); return; }

  const ok = Math.random() <= rate / 100;
  if (ok) succ++;
  used++;
  equip.dataset.used = used; equip.dataset.succ = succ;

  if (rate === 60) total60++; else total10++;
  if (ok) totalSucc++;
  totalUsed++;
  updateSummary();

  if (!isDian && used > succ) equip.classList.add('failed');
  // é¡¯ç¤ºã€Œ1/Nã€æˆ–ã€ŒN/Nã€, å¢Šå·è£å‚™æ°¸é é¡¯ç¤ºN
  document.getElementById('title-' + idx).innerText =
    (isDian ? 'ğŸŸ§ å¢Šå·è£å‚™' : (equip.dataset.type === 'glove' ? 'ğŸ§¤ æ‰‹å¥—' : 'âš”ï¸ æ­¦å™¨')) + ` #${idx}ï¼ˆ${isDian ? (succ ? succ : 'N') + '/N' : succ + '/' + max}ï¼‰`;

  const log = document.getElementById('log-' + idx);
  if (used === 1) log.innerHTML = '';
  log.innerHTML += `ç¬¬ ${used}/${isDian ? 'N' : max} æ¬¡ (${rate}%): ${ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}<br>`;
  log.scrollTop = log.scrollHeight;
}

// è¨ˆç®—ã€Œå…¨éã€çš„æ©Ÿç‡
function calcPerfectProb(rate) {
  let equips = window.equips.filter(e =>
    e.dataset.dian !== "1" && !e.classList.contains('failed') && +e.dataset.used < +e.dataset.max
  );
  if (equips.length === 0) return 0;
  let p = 1;
  for (let e of equips) {
    let left = +e.dataset.max - +e.dataset.used;
    p *= Math.pow(rate / 100, left);
  }
  return p;
}

// å„å·è»¸ã€Œå…¨éã€æ©Ÿç‡
function calcPerfectProbByScroll() {
  let equips = window.equips.filter(e =>
    e.dataset.dian !== "1" && !e.classList.contains('failed') && +e.dataset.used < +e.dataset.max
  );
  let prob60 = 1, prob10 = 1;
  for (let e of equips) {
    let left = +e.dataset.max - +e.dataset.used;
    prob60 *= Math.pow(0.6, left);
    prob10 *= Math.pow(0.1, left);
  }
  return { prob60, prob10 };
}

// æ›´æ–° summary
function updateSummary() {
  const rate = totalUsed ? (totalSucc / totalUsed * 100).toFixed(1) : '0.0';
  const stat = {};
  window.equips.forEach(e => {
    if (e.dataset.dian === "1") return;
    const s = parseInt(e.dataset.succ); stat[s] = (stat[s] || 0) + 1;
  });
  const detail = Object.keys(stat).sort((a, b) => a - b).map(k => `âœ”ï¸ ${k} æ²ï¼š${stat[k]} ä»¶`).join('ï½œ');
  const prob = calcPerfectProbByScroll();
  document.getElementById('summary').innerHTML =
    `60% å·è»¸ï¼š${total60} å¼µï½œ10% å·è»¸ï¼š${total10} å¼µï½œæˆåŠŸï¼š${totalSucc} / ${totalUsed}ï¼ˆ${rate} %ï¼‰<br>
     ğŸ¯ æˆåŠŸæ²æ•¸çµ±è¨ˆï¼š<br>${detail || "ï¼ˆå°šç„¡è³‡æ–™ï¼‰"}<br>
     <hr style="border:0;border-top:1px dashed #aaa">
     <b>å‰©é¤˜è£å‚™ã€Œå…¨éã€æ©Ÿç‡ï¼š</b><br>
     â–¶ï¸ 60%å·è»¸å…¨éï¼š${(prob.prob60 * 100).toFixed(4)}%<br>
     â–¶ï¸ 10%å·è»¸å…¨éï¼š${(prob.prob10 * 100).toFixed(8)}%
    `;
}

// é‡è£½ï¼ˆåªé‡ç½®è¡å·æ¬¡æ•¸/çµæœï¼‰
function resetAll() {
  window.equips.forEach(e => {
    const max = +e.dataset.max, idx = e.dataset.idx, isDian = e.dataset.dian === "1";
    e.dataset.used = 0; e.dataset.succ = 0; e.classList.remove('failed');
    document.getElementById('title-' + idx).innerText =
      (isDian ? 'ğŸŸ§ å¢Šå·è£å‚™' : (e.dataset.type === 'glove' ? 'ğŸ§¤ æ‰‹å¥—' : 'âš”ï¸ æ­¦å™¨')) + ` #${idx}ï¼ˆ${isDian ? 'N/N' : '0/' + max}ï¼‰`;
    document.getElementById('log-' + idx).innerText = 'å°šæœªä½¿ç”¨å·è»¸';
  });
  total60 = total10 = totalSucc = totalUsed = 0;
  selectedScroll = null;
  document.querySelectorAll('.scroll img').forEach(i => i.classList.remove('selected'));
  updateSummary();
}

generateEquips();
</script>
</body>
</html>
